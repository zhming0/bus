<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>@node-ts/bus-workflow | @node-ts/bus</title>
    <meta name="description" content="Enterprise message bus library for typescript">
    
    
    <link rel="preload" href="/bus/assets/css/0.styles.e5b324c2.css" as="style"><link rel="preload" href="/bus/assets/js/app.a26ebe03.js" as="script"><link rel="preload" href="/bus/assets/js/14.ead65cb8.js" as="script"><link rel="prefetch" href="/bus/assets/js/10.df59cb5e.js"><link rel="prefetch" href="/bus/assets/js/11.053fff12.js"><link rel="prefetch" href="/bus/assets/js/12.e52461bd.js"><link rel="prefetch" href="/bus/assets/js/13.51605591.js"><link rel="prefetch" href="/bus/assets/js/15.03c70588.js"><link rel="prefetch" href="/bus/assets/js/16.1d8f5c30.js"><link rel="prefetch" href="/bus/assets/js/17.dee4e52f.js"><link rel="prefetch" href="/bus/assets/js/18.aad36138.js"><link rel="prefetch" href="/bus/assets/js/2.afc26b7e.js"><link rel="prefetch" href="/bus/assets/js/3.a254d9fb.js"><link rel="prefetch" href="/bus/assets/js/4.bef9ce78.js"><link rel="prefetch" href="/bus/assets/js/5.a22c922c.js"><link rel="prefetch" href="/bus/assets/js/6.e323f766.js"><link rel="prefetch" href="/bus/assets/js/7.d60115d1.js"><link rel="prefetch" href="/bus/assets/js/8.559dd821.js"><link rel="prefetch" href="/bus/assets/js/9.25fc9bcf.js">
    <link rel="stylesheet" href="/bus/assets/css/0.styles.e5b324c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/bus/" class="home-link router-link-active"><!----> <span class="site-name">@node-ts/bus</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link router-link-exact-active router-link-active">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/bus/" class="nav-link">Home</a></div><div class="nav-item"><a href="/bus/packages/bus-core/src/handler/" class="nav-link">Handlers</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Transports</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-sqs/" class="nav-link">SQS</a></li><li class="dropdown-item"><!----> <a href="/bus/packages/bus-rabbitmq/" class="nav-link">RabbitMQ</a></li></ul></div></div><div class="nav-item"><a href="/bus/packages/bus-workflow/" class="nav-link router-link-exact-active router-link-active">Workflows</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Persistence</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/bus/packages/bus-postgres/" class="nav-link">Postgres</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/node-ts/bus" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/bus/" class="sidebar-link">Home</a></li><li><a href="/bus/packages/bus-messages/" class="sidebar-link">Messages</a></li><li><a href="/bus/packages/bus-core/src/handler/" class="sidebar-link">Handlers</a></li><li><a href="/bus/packages/bus-core/src/transport/" class="sidebar-link">Transports</a></li><li><a href="/bus/packages/bus-workflow/" class="active sidebar-link">Workflows</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#installation" class="sidebar-link">Installation</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#concepts" class="sidebar-link">Concepts</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#workflow" class="sidebar-link">Workflow</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#workflow-data" class="sidebar-link">Workflow Data</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#attributes" class="sidebar-link">Attributes</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#operation" class="sidebar-link">Operation</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#persistence" class="sidebar-link">Persistence</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#reliability" class="sidebar-link">Reliability</a></li></ul></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#creating-a-new-workflow" class="sidebar-link">Creating a new Workflow</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#completing-a-workflow" class="sidebar-link">Completing a workflow</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#discarding-state-changes" class="sidebar-link">Discarding state changes</a></li><li class="sidebar-sub-header"><a href="/bus/packages/bus-workflow/#example" class="sidebar-link">Example</a></li></ul></li></ul></li><li><a href="/bus/packages/bus-workflow/src/workflow/persistence/" class="sidebar-link">Persistence</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="node-ts-bus-workflow"><a href="#node-ts-bus-workflow" aria-hidden="true" class="header-anchor">#</a> @node-ts/bus-workflow</h1> <p><a href="https://greenkeeper.io/" target="_blank" rel="noopener noreferrer"><img src="https://badges.greenkeeper.io/node-ts/bus.svg" alt="Greenkeeper badge"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://circleci.com/gh/node-ts/bus/tree/master" target="_blank" rel="noopener noreferrer"><img src="https://circleci.com/gh/node-ts/bus/tree/master.svg?style=svg" alt="CircleCI"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><a href="https://opensource.org/licenses/MIT" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/License-MIT-green.svg" alt="License: MIT"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Workflows are a pattern that help you write applications that scale in both size and complexity. This library is built for performance and can be scaled to meet the needs of both modest and enterprise scale systems.</p> <p>Workflows (aka sagas, process managers, long running processes, message driven state machines), are a way to orchestrate higher level logic over a distributed or reliable/durable system. This is a key <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html" target="_blank" rel="noopener noreferrer">enterprise integration pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p><img src="https://github.com/node-ts/bus/blob/master/packages/bus-workflow/assets/workflow.gif?raw=true" alt="Workflow" title="Workflow"></p> <p>In plain English, workflows subscribe to various messages in your system, make decisions based on what they see, and send out commands based on the logic of your business. Because of this, the rest of your application can focus on logic to process individual command messages that each have a single responsibility.</p> <p>Workflows are often started by a particular message (eg: <code>OrderPlaced</code>) and coordinate all the activities to complete a process. In this case, the workflow would be responsible for fulfilling an order, which may mean capturing payment, picking inventory, shipping, sending receipts etc. These steps may be independent of one another, or dependent and must be executed in order. The process may take a few seconds, or a few weeks.</p> <p>Regardless of these behaviours, the workflow will listen for events that signal the completion of each step, and may send out commands to invoke the next step. Once all steps have completed, the workflow will flag itself as complete and no further actions will be taken by it.</p> <h2 id="installation"><a href="#installation" aria-hidden="true" class="header-anchor">#</a> Installation</h2> <p>Ideally services that host workflows should be somewhat isolated and contain no other concerns. Workflows should be able to make decisions about what logic to execute based on the messages it sees and without having to query databases.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i reflect-metadata inversify @node-ts/bus-workflow @node-ts/bus-core
</code></pre></div><h2 id="concepts"><a href="#concepts" aria-hidden="true" class="header-anchor">#</a> Concepts</h2> <p>The following concepts are useful in understanding how workflows work and how to use them effectively.</p> <h3 id="workflow"><a href="#workflow" aria-hidden="true" class="header-anchor">#</a> Workflow</h3> <p>A workflow models a long running business process. In the context of an existing business, it's something that probably already exists such as the series of steps to perform when hiring new staff, how to process a product return etc. These processes are a series of steps that need to be performed in order to achieve a desired outcome.</p> <p><code>@node-ts/bus-workflow</code> provides a framework where these series of steps can be modeled as a Typescript class definition that contains a number of message handling functions. These functions react to changes in the business environment, such as when one step has completed so that the next can begin.</p> <h3 id="workflow-data"><a href="#workflow-data" aria-hidden="true" class="header-anchor">#</a> Workflow Data</h3> <p>Workflow data contains the current state of a running workflow. For instance when hiring new staff, HR, IT, and Accounting may all need to perform certain steps so that a new employee is established. The outcomes of some of these individual steps may contain data that needs to be sent to subsequent steps.</p> <p><code>@node-ts/bus-workflow</code> persists and can update the state data for the duration of the workflow's lifetime. This data is made available to all message handling functions as they're invoked.</p> <h3 id="attributes"><a href="#attributes" aria-hidden="true" class="header-anchor">#</a> Attributes</h3> <p>A workflow consists of:</p> <ul><li>the <code>$name</code> of the workflow</li> <li>1..n messages that starts a workflow</li> <li>0..n messages that trigger the next step in a workflow</li> <li><code>WorkflowData</code> that holds the current state of the workflow</li> <li>a call to <code>workflowComplete()</code> that signals the completion of a workflow</li></ul> <h3 id="operation"><a href="#operation" aria-hidden="true" class="header-anchor">#</a> Operation</h3> <p>Workflows subscribe themselves to all messages they handle - both <code>StartedBy</code> handlers that create a new instance of a workflow, and <code>Handles</code> that pass the message to an existing instance of a workflow.</p> <p>When a message arrives that starts a new workflow, a new instance of that workflow is started by <code>@node-ts/bus-workflow</code> with the message passed to the appropriate <code>StartedBy</code> handler. The handler is responsible sending any commands and then returning a <code>WorkflowData</code> object of values that represent, or are used by, the state of the workflow.</p> <p><code>@node-ts/bus-workflow</code> stores the returned workflow state in the configured persistence provider for use by the next message that needs to be handled by the workflow. When this message arrives, the persistence is queried for all workflow data values depending on the mapping the developer has provided. This data value is passed with the message to the handler method, which can send further commands, make modifications to the workflow state, return an updated state to be persisted, and optionally signal that the workflow has completed.</p> <h3 id="persistence"><a href="#persistence" aria-hidden="true" class="header-anchor">#</a> Persistence</h3> <p>Because workflows are long running (they can last up to months or longer) and also operate in a distributed messaging environment, holding the <code>WorkflowData</code> in memory until completion is very dangerous. A process or server restart would irrevocably wipe out the current state of the workflow.</p> <p>Instead, <code>@node-ts/bus-workflow</code> remains a stateless service by persisting <code>WorkflowData</code> into a database. Each time a message arrives, the <code>WorkflowData</code> is retrieved from a shared persistence provider, and is persisted back with any updates when the message handling resolves.</p> <p>The persistence takes care of concurrency issues when multiple concurrent handlers write the same <code>WorkflowData</code> using optimistic locking and item versioning. This eliminates the need for more pessimistic locking techniques that don't scale (and aren't supported in many distributed data providers).</p> <h3 id="reliability"><a href="#reliability" aria-hidden="true" class="header-anchor">#</a> Reliability</h3> <p>Workflows have the same reliability guarantees as normal <a href="/bus/packages/bus-core/src/handler/">message handlers</a>. Any internal errors, failures to commit workflow data, or failures to send outgoing messages will result in the operation aborting and the originating message being placed back on the queue for retry.</p> <h2 id="creating-a-new-workflow"><a href="#creating-a-new-workflow" aria-hidden="true" class="header-anchor">#</a> Creating a new Workflow</h2> <p>A workflow must have the following conditions met:</p> <ol><li>Implement <code>Workflow&lt;&gt;</code> from <code>@node-ts/bus-workflow</code></li> <li>Define a <code>WorkflowData</code> type that extends <code>WorkflowData</code> from <code>@node-ts/bus-workflow</code></li> <li>Contain at least 1 message handling function decorated with <code>StartedBy</code></li> <li>Contain at least 1 message handling function that returns <code>this.complete()</code> from the super class <code>Workflow&lt;&gt;</code></li> <li>Be registered with the <code>WorkflowRegistry</code> from <code>@node-ts/bus-workflow</code></li></ol> <h3 id="completing-a-workflow"><a href="#completing-a-workflow" aria-hidden="true" class="header-anchor">#</a> Completing a workflow</h3> <p>Workflows that have completed their work should be marked as completed. This means that they will no longer react to any future events. This is done by returning <code>this.complete()</code> at the end of your message handler.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ProcessDocumentWorkflow</span> <span class="token keyword">extends</span> <span class="token class-name">Workflow</span><span class="token operator">&lt;</span>ProcessDocumentWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  @Handles<span class="token operator">&lt;</span>DocumentSaved<span class="token punctuation">,</span> ProcessDocumentWorkflowData<span class="token punctuation">,</span> <span class="token string">'handlesDocumentSaved'</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>DocumentSaved<span class="token punctuation">)</span>
  <span class="token function">handlesDocumentSaved</span> <span class="token punctuation">(</span>_<span class="token punctuation">:</span> DocumentSaved<span class="token punctuation">)</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>ProcessDocumentWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="discarding-state-changes"><a href="#discarding-state-changes" aria-hidden="true" class="header-anchor">#</a> Discarding state changes</h3> <p>Occasionally there are times when the workflow data shouldn't persist after a message has been handled. This is particularly relevant in cases where a workflow should only handle a message under certain circumstances.</p> <p>For example, if your workflow is started by an <code>S3ObjectCreated</code> event, but should only create a new workflow if the object key is prefixed with <code>/documents</code>, then this can be achieved by returning <code>this.discard()</code> in the workflow like so:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code>@<span class="token function">injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ProcessDocumentWorkflow</span> <span class="token keyword">extends</span> <span class="token class-name">Workflow</span><span class="token operator">&lt;</span>ProcessDocumentWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  @StartedBy<span class="token operator">&lt;</span>S3ObjectCreated<span class="token punctuation">,</span> ProcessDocumentWorkflowData<span class="token punctuation">,</span> <span class="token string">'handlesS3ObjectCreated'</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>S3ObjectCreated<span class="token punctuation">)</span>
  <span class="token function">handlesS3ObjectCreated</span> <span class="token punctuation">(</span>s3ObjectCreated<span class="token punctuation">:</span> S3ObjectCreated<span class="token punctuation">)</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>ProcessDocumentWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s3ObjectCreated<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'/documents'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Starts a new workflow</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">discard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Do not start a new workflow</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="example"><a href="#example" aria-hidden="true" class="header-anchor">#</a> Example</h3> <p>The following represents a simple workflow that sends a welcome message to new users and subscribes them to a mailing list.</p> <p><code>user-signup-workflow-data.ts</code> is a workflow data definition that describes the state that the workflow will create and update throughout its lifetime.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// user-signup-workflow-data.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> WorkflowData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-workflow'</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserSignupWorkflowData</span> <span class="token keyword">extends</span> <span class="token class-name">WorkflowData</span> <span class="token punctuation">{</span>
  <span class="token comment">// The name needs to be unique to distinguish it from other persisted workflow</span>
  <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token constant">NAME</span> <span class="token operator">=</span> <span class="token string">'node-ts/bus-workflow/user-signup-workflow-data'</span>
  <span class="token keyword">readonly</span> $name <span class="token operator">=</span> UserSignupWorkflowData<span class="token punctuation">.</span><span class="token constant">NAME</span>

  email<span class="token punctuation">:</span> <span class="token builtin">string</span>
  welcomeEmailSent<span class="token punctuation">:</span> <span class="token builtin">boolean</span>
  subscribedToMailingList<span class="token punctuation">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>user-signup-workflow.ts</code> contains the workflow definition. It describes what messages start the workflow (<code>UserSignedUp</code>) and which subsequent messages it listens for and handles (<code>WelcomeEmailSent</code>, <code>SubscribedToMailingList</code>).</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// user-signup-workflow.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  UserSignedUp<span class="token punctuation">,</span>
  SendWelcomeEmail<span class="token punctuation">,</span>
  SubscribeToMailingList<span class="token punctuation">,</span>
  Uuid
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'contracts'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Workflow <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-workflow'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'inversify'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserSignupWorkflowData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user-signup-workflow-data'</span>

@<span class="token function">injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserSignupWorkflow</span> <span class="token keyword">extends</span> <span class="token class-name">Workflow</span><span class="token operator">&lt;</span>UserSignupWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">constructor</span> <span class="token punctuation">(</span>
    <span class="token parameter">@<span class="token function">inject</span><span class="token punctuation">(</span><span class="token constant">BUS_SYMBOLS</span><span class="token punctuation">.</span>Bus<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">readonly</span> bus<span class="token punctuation">:</span> Bus</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Starts a new workflow when a user has signed up
   */</span>
  @StartedBy<span class="token operator">&lt;</span>UserSignedUp<span class="token punctuation">,</span> UserSignupWorkflowData<span class="token punctuation">,</span> <span class="token string">'handlesUserSignedUp'</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>UserSignedUp<span class="token punctuation">)</span>
  <span class="token function">handlesUserSignedUp</span> <span class="token punctuation">(</span>event<span class="token punctuation">:</span> UserSignedUp<span class="token punctuation">)</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>UserSignupWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sendWelcomeEmail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendWelcomeEmail</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>sendWelcomeEmail<span class="token punctuation">)</span>

    <span class="token keyword">const</span> subscribeToMailingList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubscribeToMailingList</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>email<span class="token punctuation">)</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bus<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>subscribeToMailingList<span class="token punctuation">)</span>

    <span class="token comment">// Store the initial workflow state</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> event<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
      welcomeEmailSent<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      subscribedToMailingList<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Handle when the welcome email has been sent. Because there's one of these messages for each user signing up, we need
   * to find the correct workflow data by mapping the 'email' field in the event to the 'email' field in the workflow data.
   */</span> 
  @Handles<span class="token operator">&lt;</span>WelcomeEmailSent<span class="token punctuation">,</span> UserSignupWorkflowData<span class="token punctuation">,</span> <span class="token string">'handlesWelcomeEmailSent'</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
    WelcomeEmailSent<span class="token punctuation">,</span>
    <span class="token parameter">event</span> <span class="token operator">=&gt;</span> event<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    <span class="token string">'email'</span>
  <span class="token punctuation">)</span>
  <span class="token function">handlesWelcomeEmailSent</span> <span class="token punctuation">(</span>_<span class="token punctuation">:</span> WelcomeEmailSent<span class="token punctuation">,</span> workflowData<span class="token punctuation">:</span> UserSignupWorkflowData<span class="token punctuation">)</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>UserSignupWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workflowData<span class="token punctuation">.</span>subscribedToMailingList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">{</span> welcomeEmailSent<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// We're still waiting for the mailing list subscription to go through, so just return these state changes to be persisted</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> welcomeEmailSent<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  @Handles<span class="token operator">&lt;</span>SubscribedToMailingList<span class="token punctuation">,</span> UserSignupWorkflowData<span class="token punctuation">,</span> <span class="token string">'handlesSubscribedToMailingList'</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
    SubscribedToMailingList<span class="token punctuation">,</span>
    <span class="token parameter">event</span> <span class="token operator">=&gt;</span> event<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    <span class="token string">'email'</span>
  <span class="token punctuation">)</span>
  <span class="token function">handlesSubscribedToMailingList</span> <span class="token punctuation">(</span>_<span class="token punctuation">:</span> SubscribedToMailingList<span class="token punctuation">,</span> workflowData<span class="token punctuation">:</span> UserSignupWorkflowData<span class="token punctuation">)</span><span class="token punctuation">:</span> Partial<span class="token operator">&lt;</span>UserSignupWorkflowData<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workflowData<span class="token punctuation">.</span>welcomeEmailSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token punctuation">{</span> subscribedToMailingList<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// We're still waiting for the welcome email to be sent, so just return these state changes to be persisted</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      subscribedToMailingList<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>workflow-container.ts</code> is an example on how to register the workflow with the workflow registry and then how to start the service running. This uses <a href="http://inversify.io/" target="_blank" rel="noopener noreferrer">Inversify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as the IoC provider.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// workflow-container.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Container <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'inversify'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BusModule<span class="token punctuation">,</span> ApplicationBootstrap<span class="token punctuation">,</span> <span class="token constant">BUS_SYMBOLS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-core'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BusWorkflowModule<span class="token punctuation">,</span> WorkflowRegistry<span class="token punctuation">,</span> <span class="token constant">BUS_WORKFLOW_SYMBOLS</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@node-ts/bus-workflow'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserSignupWorkflow<span class="token punctuation">,</span> UserSignupWorkflowData <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./user-signup-workflow'</span>

<span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Container</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
container<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">BusModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">BusWorkflowModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// Register the workflow with the registry so all the underlying messaging infrastructure can be initialized</span>
<span class="token keyword">const</span> workflowRegistry <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>WorkflowRegistry<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token constant">BUS_WORKFLOW_SYMBOLS</span><span class="token punctuation">.</span>WorkflowRegistry<span class="token punctuation">)</span>
workflowRegistry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>UserSignupWorkflow<span class="token punctuation">,</span> UserSignupWorkflowData<span class="token punctuation">)</span>

<span class="token keyword">const</span> bootstrap <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token operator">&lt;</span>ApplicationBootstrap<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token constant">BUS_SYMBOLS</span><span class="token punctuation">.</span>ApplicationBootstrap<span class="token punctuation">)</span>
<span class="token keyword">await</span> bootstrap<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>

<span class="token comment">// Starts the bus listening for message that will be dispatched to workflows</span>
workflowRegistry<span class="token punctuation">.</span><span class="token function">initializeWorkflows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> bootstrap<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/bus/packages/bus-core/src/transport/" class="prev">
          Transports
        </a></span> <span class="next"><a href="/bus/packages/bus-workflow/src/workflow/persistence/">
          Persistence
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/bus/assets/js/app.a26ebe03.js" defer></script><script src="/bus/assets/js/14.ead65cb8.js" defer></script>
  </body>
</html>
